<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPortal | NearU</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #4f46e5; --secondary: #f59e0b; --dark: #1e293b; --light: #f8fafc; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--light); color: var(--dark); }
        .hidden { display: none !important; }

        /* Auth Screen */
        #auth-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #4f46e5, #7c3aed); }
        .auth-card { background: white; padding: 2.5rem; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px rgba(0,0,0,0.15); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; cursor: pointer; border-radius: 8px; font-weight: bold; background: #f1f5f9; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 10px; font-size: 15px; }
        .btn-main { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px; }

        /* Navigation */
        nav { background: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .nav-links { display: flex; gap: 20px; list-style: none; align-items: center; }
        .nav-links a { text-decoration: none; color: var(--dark); font-weight: 500; cursor: pointer; }
        .logout-btn { color: #ef4444 !important; border: 1px solid #fee2e2; padding: 6px 15px; border-radius: 8px; font-weight: bold; transition: 0.3s; background: #fff1f2; }
        .logout-btn:hover { background: #ef4444; color: white !important; }

        /* Dashboard Items */
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        .hero { background: white; padding: 2rem; border-radius: 15px; border-left: 6px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 2rem 0; }
        .btn-action { padding: 1.5rem; border-radius: 12px; border: none; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        @media (max-width: 768px) {
            .nav-links { display: none; }
            .nav-links.mobile-active { display: flex; flex-direction: column; position: absolute; top: 100%; left: 0; width: 100%; background: white; padding: 20px; box-shadow: 0 10px 10px rgba(0,0,0,0.1); }
            .action-btns { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="auth-page">
        <div class="auth-card">
            <h2 style="text-align: center; margin-bottom: 20px;">EduPortal</h2>
            <div class="tabs">
                <button class="tab-btn active" id="loginTab">Login</button>
                <button class="tab-btn" id="signupTab">Sign Up</button>
            </div>
            <form id="auth-form">
                <input type="text" id="regName" class="hidden" placeholder="Full Name">
                <input type="email" id="email" placeholder="Email Address" required>
                <input type="password" id="password" placeholder="Password" required>
                <select id="roleSelect">
                    <option value="student">Student Account</option>
                    <option value="admin">Admin Account</option>
                </select>
                <input type="password" id="adminKey" class="hidden" placeholder="Admin Secret Key">
                <button type="submit" class="btn-main">Sign In</button>
            </form>
            <p id="error-msg" style="color: #ef4444; text-align:center; font-size:13px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <nav>
            <div class="logo"><h3 style="color:var(--primary)">NearU Student</h3></div>
            <ul class="nav-links" id="studentNav">
                <li><a href="#">Home</a></li>
                <li><a href="#">Profile</a></li>
                <li><a onclick="handleLogout()" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
            <div style="cursor:pointer;" class="mobile-toggle" onclick="toggleNav('studentNav')">☰</div>
        </nav>
        <div class="container" id="main-content">
            <div class="hero">
                <h1 id="userDisplay">Welcome!</h1>
                <p id="dateDisplay"></p>
                <p id="quoteDisplay" style="margin-top:10px; font-style:italic;"></p>
            </div>
            <div class="action-btns">
                <button class="btn-action" style="background:var(--primary)" id="viewPyqBtn"><i class="fas fa-book-open"></i> View PYQs</button>
                <button class="btn-action" style="background:var(--secondary)"><i class="fas fa-lightbulb"></i> Important Qs</button>
            </div>
            <div class="card">
                <h3>To-Do List</h3>
                <div id="todoItems">
                    <label style="display:block; margin:8px 0;"><input type="checkbox"> Study Physics</label>
                </div>
            </div>
            <div class="card">
                <h3>Reviews</h3>
                <textarea id="revInput" placeholder="Write a review..."></textarea>
                <button class="btn-main" id="postRevBtn" style="width:auto; padding:8px 25px;">Post</button>
                <div id="revList" style="margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <nav>
            <div class="logo"><h3>NearU Admin</h3></div>
            <ul class="nav-links" id="adminNav">
                <li><a href="#">Upload History</a></li>
                <li><a onclick="handleLogout()" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
            <div style="cursor:pointer;" class="mobile-toggle" onclick="toggleNav('adminNav')">☰</div>
        </nav>
        <div class="container">
            <div class="card">
                <h2>Admin Upload</h2>
                <input type="text" id="upSubj" placeholder="Subject">
                <input type="number" id="upYear" placeholder="Year">
                <select id="upSem"><option>Semester 1</option><option>Semester 2</option></select>
                <input type="file" id="fileInput">
                <button class="btn-main" id="uploadBtn" style="background:#10b981;">Confirm Upload</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBwjI1WxObDvOd9v0E7WrB69IwhLX6Uhr4",
            authDomain: "nearu-c2bcd.firebaseapp.com",
            projectId: "nearu-c2bcd",
            storageBucket: "nearu-c2bcd.firebasestorage.app",
            messagingSenderId: "406211381950",
            appId: "1:406211381950:web:008b8d04d618a2c579acef"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- AUTH & UI TOGGLES ---
        window.toggleNav = (id) => document.getElementById(id).classList.toggle('mobile-active');
        
        const loginTab = document.getElementById('loginTab');
        const signupTab = document.getElementById('signupTab');
        const roleSelect = document.getElementById('roleSelect');
        const adminKey = document.getElementById('adminKey');
        let isLogin = true;

        loginTab.onclick = () => { isLogin = true; loginTab.classList.add('active'); signupTab.classList.remove('active'); document.getElementById('regName').classList.add('hidden'); };
        signupTab.onclick = () => { isLogin = false; signupTab.classList.add('active'); loginTab.classList.remove('active'); document.getElementById('regName').classList.remove('hidden'); };
        roleSelect.onchange = () => adminKey.classList.toggle('hidden', roleSelect.value !== 'admin');

        // --- LOGOUT LOGIC ---
        window.handleLogout = () => {
            signOut(auth).then(() => {
                window.location.reload();
            }).catch(err => alert(err.message));
        };

        // --- AUTH SUBMISSION ---
        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if(isLogin) {
                if(roleSelect.value === 'admin' && adminKey.value !== "ADMIN123") return alert("Wrong Admin Key!");
                await signInWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
            } else {
                await createUserWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
            }
        };

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('auth-page').classList.add('hidden');
                if(roleSelect.value === 'admin') {
                    document.getElementById('admin-panel').classList.remove('hidden');
                } else {
                    document.getElementById('dashboard').classList.remove('hidden');
                    document.getElementById('userDisplay').innerText = `Hello, ${user.email.split('@')[0]}!`;
                    document.getElementById('dateDisplay').innerText = new Date().toDateString();
                    document.getElementById('quoteDisplay').innerText = `"Success is the sum of small efforts repeated daily."`;
                    loadReviews();
                }
            } else {
                document.getElementById('auth-page').classList.remove('hidden');
            }
        });

        // --- ADMIN UPLOAD ---
        document.getElementById('uploadBtn').onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            const subj = document.getElementById('upSubj').value;
            if(!file || !subj) return alert("Missing file or subject!");

            const sRef = ref(storage, `pyqs/${Date.now()}_${file.name}`);
            try {
                const snap = await uploadBytes(sRef, file);
                const url = await getDownloadURL(snap.ref);
                await addDoc(collection(db, "pyqs"), { subject: subj, year: document.getElementById('upYear').value, sem: document.getElementById('upSem').value, fileUrl: url, time: serverTimestamp() });
                alert("Upload Success!");
            } catch (err) { alert(err.message); }
        };

        // --- REVIEWS & PYQ LIBRARY ---
        function loadReviews() {
            onSnapshot(query(collection(db, "reviews"), orderBy("time", "desc")), (snap) => {
                const list = document.getElementById('revList');
                list.innerHTML = "";
                snap.forEach(doc => list.innerHTML += `<div class="card" style="margin-top:10px; padding:10px;"><strong>${doc.data().user.split('@')[0]}</strong>: ${doc.data().text}</div>`);
            });
        }

        document.getElementById('postRevBtn').onclick = async () => {
            const val = document.getElementById('revInput').value;
            if(val) await addDoc(collection(db, "reviews"), { text: val, user: auth.currentUser.email, time: serverTimestamp() });
            document.getElementById('revInput').value = "";
        };

        document.getElementById('viewPyqBtn').onclick = async () => {
            const main = document.getElementById('main-content');
            main.innerHTML = "<h3>Fetching Library...</h3>";
            const snap = await getDocs(query(collection(db, "pyqs"), orderBy("time", "desc")));
            let html = `<h2>PYQ Library</h2><div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:15px; margin-top:20px;">`;
            snap.forEach(doc => {
                const d = doc.data();
                html += `<div class="card" style="margin:0; border-top:5px solid var(--primary)"><h4>${d.subject}</h4><p>${d.year} | ${d.sem}</p><a href="${d.fileUrl}" target="_blank" class="btn-main" style="display:block; text-align:center; text-decoration:none;">Open File</a></div>`;
            });
            html += `</div><button class="btn-main" onclick="location.reload()" style="background:#64748b; margin-top:20px;">Return Home</button>`;
            main.innerHTML = html;
        };
    </script>
</body>
</html>
